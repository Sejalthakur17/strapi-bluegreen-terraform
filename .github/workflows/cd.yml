name: CD - ECS Blue Green Deployment

on:
  workflow_run:
    workflows: ["CI - Build & Push to ECR"]
    types:
      - completed

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: sejal-strapi-bluegreen
  TASK_DEFINITION_FAMILY: sejal-bluegreen-task
  CONTAINER_NAME: sejal-strapi
  CONTAINER_PORT: 1337
  CODEDEPLOY_APPLICATION: sejal-strapi-codedeploy-app
  CODEDEPLOY_DEPLOYMENT_GROUP: strapi-deployment-group
  S3_BUCKET: sejal-task-10

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV

      - name: Set Image URI
        run: |
          IMAGE_URI=${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPOSITORY}:${{ github.event.workflow_run.head_sha }}
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

      - name: Fetch Current Task Definition
        run: |
          aws ecs describe-task-definition \
            --task-definition $TASK_DEFINITION_FAMILY \
            --query taskDefinition > task-def.json

      - name: Update Task Definition with New Image
        run: |
          jq --arg IMAGE "$IMAGE_URI" \
          '.containerDefinitions[0].image = $IMAGE |
           del(.taskDefinitionArn,
               .revision,
               .status,
               .requiresAttributes,
               .compatibilities,
               .registeredAt,
               .registeredBy)' \
          task-def.json > new-task-def.json

      - name: Register New Task Definition
        run: |
          NEW_TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "NEW_TASK_DEF_ARN=$NEW_TASK_DEF_ARN" >> $GITHUB_ENV

      - name: Generate AppSpec File
        run: |
          cat <<EOF > appspec.json
          {
            "version": 1,
            "Resources": [
              {
                "TargetService": {
                  "Type": "AWS::ECS::Service",
                  "Properties": {
                    "TaskDefinition": "${NEW_TASK_DEF_ARN}",
                    "LoadBalancerInfo": {
                      "ContainerName": "${CONTAINER_NAME}",
                      "ContainerPort": ${CONTAINER_PORT}
                    }
                  }
                }
              }
            ]
          }
          EOF

      - name: Upload AppSpec to S3
        run: |
          aws s3 cp appspec.json s3://${S3_BUCKET}/appspec.json

      # ğŸ”¥ Trigger Deployment (with step ID)
      - name: Trigger CodeDeploy Deployment
        id: deploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
          --application-name $CODEDEPLOY_APPLICATION \
          --deployment-group-name $CODEDEPLOY_DEPLOYMENT_GROUP \
          --deployment-config-name CodeDeployDefault.ECSCanary10Percent5Minutes \
          --revision '{
            "revisionType": "S3",
            "s3Location": {
              "bucket": "'"${S3_BUCKET}"'",
              "key": "appspec.json",
              "bundleType": "JSON"
            }
          }' \
          --query deploymentId \
          --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "Deployment ID: $DEPLOYMENT_ID"

      # ğŸ” Wait for deployment
      - name: Wait for Deployment to Succeed
        run: |
          aws deploy wait deployment-successful \
            --deployment-id ${{ steps.deploy.outputs.deployment_id }}

      # ğŸ”„ Rollback if deployment fails
      - name: Rollback if failed
        if: failure()
        run: |
          echo "Deployment failed. Initiating rollback..."
          aws deploy stop-deployment \
            --deployment-id ${{ steps.deploy.outputs.deployment_id }} \
            --auto-rollback-enabled